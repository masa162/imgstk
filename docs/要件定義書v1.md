# imgstk 要件定義書 v1.0

## 1. プロジェクト概要

### 1.1 目的
JAMstack（Hugo/Astro）で運用する静的サイト向けの、大量画像を一括アップロード・管理できるシンプルなCDNシステム。

### 1.2 背景
- 現在ロリポップレンタルサーバーで運用している画像CDNをCloudflare R2に移行
- フォトギャラリー系ブログで100〜200枚単位の画像を扱う
- 長期的に安定・堅牢な運用を実現
- R2のフラット構造 + DBの連番管理で革新的な設計

### 1.3 既存システムとの関係
- **imgbase**: ブログ執筆時の日常使い（1枚ずつ、検索・管理機能充実）
- **imgstk**: フォトギャラリー用一括アップロード（100〜200枚、アーカイブ重視）
- 2つは完全に独立したシステム

## 2. 技術スタック

### 2.1 インフラ（100% Cloudflare）
- **Cloudflare R2**: 画像ストレージ（S3互換）
- **Cloudflare D1**: メタデータ管理（SQLite互換）
- **Cloudflare Workers**: CDN配信専用
- **Cloudflare Pages**: 管理画面ホスティング + API（Pages Functions）

### 2.2 フレームワーク・ライブラリ
- **Hono**: Pages Functions用軽量フレームワーク
- **Vanilla JavaScript**: フロントエンド（最軽量・最安定）
- **Tailwind CSS**: スタイリング（CDN経由）

### 2.3 開発ツール
- **Wrangler CLI**: Cloudflareデプロイツール
- **TypeScript**: Worker/Functions開発

## 3. システム設計

### 3.1 URL構造

#### CDN配信（Worker）
```
https://stk.be2nd.com/00000001.webp
https://stk.be2nd.com/00000002.webp
...
https://stk.be2nd.com/99999999.webp
```

#### 管理画面（Pages）
```
https://admin-stk.be2nd.com/           # アップロード画面
https://admin-stk.be2nd.com/gallery    # バッチ一覧
```

### 3.2 連番形式
- **形式**: 8桁数字（`00000001` 〜 `99999999`）
- **容量**: 9999万枚（実質無限）
- **管理**: D1でグローバルカウンター管理
- **採番**: トランザクションで衝突防止
- **欠番**: 削除時も連番は詰めない（歯抜けOK）

### 3.3 R2バケット構造
```
imgstk-bucket/
├── 00000001.webp
├── 00000002.webp
├── 00000003.webp
...
└── 99999999.webp
```
- フラット構造（prefixなし）
- 高速配信
- S3/R2のベストプラクティス

### 3.4 データベース設計

#### sequenceテーブル（連番カウンター）
```sql
CREATE TABLE sequence (
  id INTEGER PRIMARY KEY CHECK (id = 1),
  current_number INTEGER NOT NULL,  -- 現在の最大番号
  updated_at TEXT NOT NULL
);
```

#### batchesテーブル（バッチ管理）
```sql
CREATE TABLE batches (
  id TEXT PRIMARY KEY,              -- UUID
  title TEXT NOT NULL,              -- 'Plant Observation 2025-11-21'
  uploaded_at TEXT NOT NULL,        -- ISO8601
  image_count INTEGER NOT NULL,
  first_id INTEGER NOT NULL,        -- 1
  last_id INTEGER NOT NULL,         -- 100
  created_at TEXT NOT NULL
);
```

#### imagesテーブル（画像メタデータ）
```sql
CREATE TABLE images (
  id INTEGER PRIMARY KEY,           -- 1, 2, 3...
  batch_id TEXT NOT NULL,
  filename TEXT NOT NULL,           -- '00000001.webp'
  url TEXT NOT NULL,                -- 'https://stk.be2nd.com/00000001.webp'
  original_filename TEXT,
  bytes INTEGER NOT NULL,
  mime TEXT NOT NULL,
  uploaded_at TEXT NOT NULL,
  FOREIGN KEY (batch_id) REFERENCES batches(id) ON DELETE CASCADE
);

CREATE INDEX idx_images_batch_id ON images(batch_id);
```

## 4. 機能要件

### 4.1 Phase 1（MVP）- 基本機能

#### 4.1.1 一括アップロード
- ドラッグ&ドロップで100〜200枚を一括アップロード
- バッチタイトル入力（例: "Plant Observation 2025-11-21"）
- 自動連番採番（DBトランザクション）
- R2にフラット配置
- 進捗表示（N/M枚完了）

#### 4.1.2 CDN配信
- `GET /00000001.webp` でR2から配信
- Cache-Control: `public, max-age=31536000, immutable`
- 高速・安定配信

#### 4.1.3 バッチ管理
- バッチ一覧表示（タイトル、日付、枚数、連番範囲）
- バッチ単位での一括削除（R2 + DB）
- 削除時は連番を詰めない（歯抜けOK）

#### 4.1.4 Markdown生成
- バッチ単位でMarkdownテンプレート自動生成
- ワンクリックでクリップボードコピー
```markdown
<!-- Plant Observation 2025-11-21 (100枚) -->
![](https://stk.be2nd.com/00000001.webp)
![](https://stk.be2nd.com/00000002.webp)
...
![](https://stk.be2nd.com/00000100.webp)
```

#### 4.1.5 認証
- Basic認証（管理画面のみ）
  - Cloudflare Dashboardの環境変数で設定
  - デプロイ後に独自の認証情報を設定すること

### 4.2 Phase 2（将来拡張）
- バッチ検索・フィルタ（日付範囲、タイトル）
- サムネイル表示
- バッチメモ機能
- バッチ編集（タイトル変更）

## 5. 非機能要件

### 5.1 パフォーマンス
- CDN配信レスポンス: 100ms以内（Cloudflare Edge）
- アップロード処理: 1枚あたり1秒以内

### 5.2 可用性
- CDN配信: 99.9%以上（Cloudflare SLA）
- 管理画面: 営業時間内（必要時のみアクセス）

### 5.3 セキュリティ
- Basic認証で管理画面保護
- CORS設定（管理画面からのみアクセス）
- アップロードサイズ制限: 1ファイル50MB

### 5.4 スケーラビリティ
- R2容量: 実質無制限
- 連番枠: 9999万枚
- D1行数制限: 問題なし（数百万行まで対応）

### 5.5 堅牢性・安定性
- Cloudflareネイティブ設計
- Honoフレームワークで軽量・安定
- Vanilla JSで依存関係最小化
- 一度アップロードしたら長期安定運用

## 6. ワークフロー

### 6.1 アップロードフロー
```
1. ローカルで前処理
   ├─ XnConvert または バッチスクリプト
   ├─ リサイズ（その時の要件に応じて）
   ├─ WebP変換
   └─ 品質調整

2. imgstk管理画面
   ├─ バッチタイトル入力
   └─ ドラッグ&ドロップで一括アップロード

3. 自動処理
   ├─ 連番採番（00000001〜）
   ├─ R2にアップロード
   └─ DBにメタデータ保存

4. Markdown生成
   ├─ バッチ一覧から選択
   ├─ Markdownテンプレート生成
   └─ クリップボードにコピー

5. JAMstack（Hugo/Astro）
   └─ Markdownファイルに貼り付け
```

### 6.2 削除フロー
```
1. バッチ一覧から対象を選択
2. 「一括削除」ボタンクリック
3. 確認ダイアログ
4. R2から画像削除
5. DBからバッチ・画像レコード削除
6. 連番は欠番として残る（詰めない）
```

## 7. プロジェクト構成

```
imgstk/
├── worker/              # Cloudflare Worker（CDN配信）
│   ├── src/
│   │   └── index.ts
│   └── wrangler.toml
│
├── functions/           # Cloudflare Pages Functions（API）
│   ├── api/
│   │   ├── [[path]].ts  # Hono統合
│   │   └── _middleware.ts
│   └── types.ts
│
├── public/              # 静的ファイル（管理画面）
│   ├── index.html
│   ├── gallery.html
│   ├── script.js
│   └── style.css
│
├── db/
│   ├── schema.sql
│   └── migrations/
│       └── 0001_init.sql
│
├── docs/
│   ├── 要件定義書v1.md
│   └── README.md
│
├── scripts/
│   └── setup.sh
│
├── wrangler.toml        # Pages設定
├── package.json
└── README.md
```

## 8. デプロイ環境

### 8.1 Cloudflare設定
- **アカウント**: `belong2jazz@gmail.com`
- **Account ID**: `c677241d7d66ff80103bab9f142128ab`
- **R2バケット**: `imgstk-bucket`（新規作成）
- **D1データベース**: `imgstk-db`（新規作成）

### 8.2 ドメイン
- **CDN**: `stk.be2nd.com` → Worker
- **管理画面**: `admin-stk.be2nd.com` → Pages

### 8.3 環境変数
#### Worker
```toml
[vars]
ALLOWED_ORIGINS = "https://admin-stk.be2nd.com"

[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "imgstk-bucket"
```

#### Pages Functions
```toml
[vars]
BASIC_AUTH_USER = "your_username"
BASIC_AUTH_PASS = "your_secure_password"

[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "imgstk-bucket"

[[d1_databases]]
binding = "DB"
database_name = "imgstk-db"
database_id = "<AUTO_GENERATED>"
```

## 9. 開発計画

### Phase 0: セットアップ（0.5日）
- リポジトリ初期化
- Cloudflare R2バケット作成
- Cloudflare D1データベース作成
- プロジェクト構造構築

### Phase 1: Worker（CDN配信）（0.5日）
- CDN配信Worker実装
- キャッシュ設定
- デプロイ・動作確認

### Phase 2: Pages Functions（API）（1.5日）
- Hono統合
- 連番採番ロジック
- アップロードAPI
- バッチ管理API
- 一括削除API
- Basic認証middleware

### Phase 3: フロントエンド（2日）
- アップロード画面（Vanilla JS）
- ドラッグ&ドロップUI
- バッチ一覧画面
- Markdown生成機能
- 一括削除機能

### Phase 4: テスト・デプロイ（1日）
- 統合テスト
- ロリポップデータ移行テスト
- 本番デプロイ
- ドメイン設定

### Phase 5: ドキュメント（0.5日）
- README作成
- 運用マニュアル
- トラブルシューティング

**合計**: 約6日間

## 10. リスク管理

### 10.1 技術リスク
| リスク | 対策 |
|--------|------|
| R2アップロード失敗 | リトライロジック実装 |
| 連番採番の衝突 | DBトランザクション使用 |
| D1の制約 | バッチサイズ上限設定 |

### 10.2 運用リスク
| リスク | 対策 |
|--------|------|
| 誤削除 | 確認ダイアログ必須 |
| R2コスト増 | 不要バッチの定期削除推奨 |
| ドメイン設定ミス | デプロイ前に確認手順整備 |

## 11. 成功基準

### 11.1 MVP完成条件
- [ ] 100枚の画像を一括アップロードできる
- [ ] 連番URLで画像配信できる
- [ ] Markdownテンプレートを生成できる
- [ ] バッチ一括削除ができる
- [ ] Basic認証で保護されている

### 11.2 品質基準
- [ ] CDN配信が100ms以内
- [ ] アップロード処理が安定動作
- [ ] UIが直感的で使いやすい
- [ ] ドキュメントが整備されている

### 11.3 移行完了条件
- [ ] ロリポップの既存画像をimgstkに移行
- [ ] JAMstackサイトのURLを更新
- [ ] 正常動作を確認

## 12. 将来展望

### 12.1 Phase 2以降の検討事項
- サムネイル自動生成（Cloudflare Images連携）
- バッチ検索・フィルタ機能
- アクセス統計（Cloudflare Analytics）
- API公開（外部サイトから利用）
- AI連携（画像自動タグ付け）

### 12.2 他システムとの統合
- imgbaseとの連携（同一アカウント管理）
- MCP連携（AI自動操作）

---

**作成日**: 2025-11-21
**バージョン**: 1.0
**作成者**: Claude Code
**承認者**: masa162

---
